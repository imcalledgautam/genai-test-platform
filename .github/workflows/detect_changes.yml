name: GenAI Test Platform - Complete CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  generate-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Detect Changed Files
        id: changes
        run: |
          echo "ðŸ” Detecting changed Python files..."
          git fetch origin main || true
          if [ "$(git rev-list --count HEAD)" -eq 1 ]; then
            echo "First commit detected. Listing all Python files."
            find . -name "*.py" > changed_files.txt
          else
            git diff --name-only HEAD~1 HEAD > changed_files.txt
          fi
          echo "Changed files:"
          cat changed_files.txt
          
          # Check if there are Python changes
          if grep -q "\.py$" changed_files.txt; then
            echo "has_python_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_python_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Context Bundle
        if: steps.changes.outputs.has_python_changes == 'true'
        run: |
          echo "ðŸ“‹ Building context bundle..."
          # Create ci_artifacts directory
          mkdir -p ci_artifacts
          
          # Try different context builders in order of preference
          if [ -f "tools/context_builder_v2.py" ]; then
            echo "Using tools/context_builder_v2.py"
            python tools/context_builder_v2.py
          elif [ -f "llm_agent/enhanced_context_builder.py" ]; then
            echo "Using llm_agent/enhanced_context_builder.py"
            python llm_agent/enhanced_context_builder.py
          elif [ -f "llm_agent/context_builder.py" ]; then
            echo "Using llm_agent/context_builder.py"
            python llm_agent/context_builder.py
          else
            echo "âš ï¸ No context builder found, creating minimal bundle"
            echo '{"files":[],"metadata":{"total_files":0,"changed_files":0}}' > ci_artifacts/context_bundle.json
          fi

      - name: Install Ollama
        if: steps.changes.outputs.has_python_changes == 'true'
        run: |
          echo "ðŸ¤– Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
          
          # Start Ollama in background
          ollama serve &
          sleep 10
          
          # Pull the model (using a smaller model for CI speed)
          echo "ðŸ“¦ Pulling Qwen2.5-Coder model..."
          ollama pull qwen2.5-coder:1.5b
          
          # Verify installation
          ollama list

      - name: Generate Tests with LLM
        id: generate_tests
        if: steps.changes.outputs.has_python_changes == 'true'
        env:
          OLLAMA_MODEL: "qwen2.5-coder:1.5b"
          OLLAMA_HOST: "http://localhost:11434"
        run: |
          echo "ðŸ§  Generating tests with LLM..."
          # Try enhanced test generator first, fallback to original
          if [ -f "tools/enhanced_test_generator.py" ]; then
            echo "Using enhanced test generator"
            python tools/enhanced_test_generator.py
          elif [ -f "llm_agent/generate_tests.py" ]; then
            echo "Using original test generator"
            python llm_agent/generate_tests.py
          else
            echo "âš ï¸ No test generator found"
          fi
          
          # Count generated tests
          if [ -d "tests/generated" ] || [ -d "tests/generated_by_llm" ]; then
            GENERATED_COUNT=$(find tests -name "*generated*.py" -type f 2>/dev/null | wc -l)
            echo "âœ… Generated $GENERATED_COUNT test files"
            echo "generated_count=$GENERATED_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No tests were generated"
            echo "generated_count=0" >> $GITHUB_OUTPUT
          fi
      - name: Upload Generated Tests
        if: steps.changes.outputs.has_python_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-tests
          path: |
            tests/generated*/
            ci_artifacts/context_bundle.json
            changed_files.txt

      - name: Create Workflow Summary
        run: |
          echo "## ðŸ¤– GenAI Test Platform - Test Generation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.has_python_changes }}" == "true" ]; then
            if [ -f "ci_artifacts/context_bundle.json" ]; then
              TOTAL_FILES=$(python -c "import json; data=json.load(open('ci_artifacts/context_bundle.json')); print(data['metadata']['total_files'])" 2>/dev/null || echo "N/A")
              CHANGED_FILES=$(python -c "import json; data=json.load(open('ci_artifacts/context_bundle.json')); print(data['metadata']['changed_files'])" 2>/dev/null || echo "N/A")
              echo "### ðŸ“Š Analysis Results" >> $GITHUB_STEP_SUMMARY
              echo "- **Total files analyzed:** $TOTAL_FILES" >> $GITHUB_STEP_SUMMARY
              echo "- **Changed files:** $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "### ðŸ§  LLM Test Generation" >> $GITHUB_STEP_SUMMARY
            GENERATED_COUNT="${{ steps.generate_tests.outputs.generated_count }}"
            if [ "$GENERATED_COUNT" -gt 0 ] 2>/dev/null; then
              echo "âœ… **$GENERATED_COUNT test files generated successfully**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Generated test files:" >> $GITHUB_STEP_SUMMARY
              
              # List generated files from both possible directories
              for dir in "tests/generated" "tests/generated_by_llm"; do
                if [ -d "$dir" ]; then
                  for file in "$dir"/*.py; do
                    if [ -f "$file" ]; then
                      echo "- \`$(basename "$file")\`" >> $GITHUB_STEP_SUMMARY
                    fi
                  done
                fi
              done
            else
              echo "âš ï¸ **No test files generated**" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. **Download the generated tests** from the artifacts section below" >> $GITHUB_STEP_SUMMARY
            echo "2. **Review and adjust imports** if needed for your project structure" >> $GITHUB_STEP_SUMMARY
            echo "3. **Run tests locally** with \`pytest tests/generated*/\`" >> $GITHUB_STEP_SUMMARY
            echo "4. **Integrate into your test suite** as needed" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- \`generated-tests\` - LLM-generated test files and context information" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Python Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "No Python files were modified in this commit, skipping test generation." >> $GITHUB_STEP_SUMMARY
          fi
