{
  "files": [
    {
      "path": "llm_agent/generate_tests.py",
      "full_text": "import os\nimport json\nimport re\nimport requests\nimport ast\nimport time\nfrom pathlib import Path\n\nROOT = Path(__file__).resolve().parents[1]\nBUNDLE = ROOT / \"ci_artifacts\" / \"context_bundle.json\"\nOUT_DIR = ROOT / \"tests\" / \"generated\"\nOUT_DIR.mkdir(parents=True, exist_ok=True)\n\nMODEL = os.getenv(\"OLLAMA_MODEL\", \"qwen2.5-coder:1.5b\")  # Smaller model for CI\nOLLAMA_HOST = os.getenv(\"OLLAMA_HOST\", \"http://localhost:11434\")\nPROMPT_TEMPLATE = (ROOT / \"llm_agent\" / \"prompt_template.txt\").read_text(encoding=\"utf-8\")\n\n\ndef load_bundle():\n    if not BUNDLE.exists():\n        raise SystemExit(f\"Context bundle not found: {BUNDLE}\")\n    return json.loads(BUNDLE.read_text(encoding=\"utf-8\"))\n\n\ndef build_prompt_for_module(bundle, module_path):\n    base = PROMPT_TEMPLATE\n    files = bundle[\"files\"]\n    ctx = bundle.get(\"context\", {})\n    targets = bundle.get(\"targets\", {})\n    chosen = [f for f in files if f[\"path\"] == module_path]\n    if not chosen:\n        return None\n    f = chosen[0]\n\n    parts = [base, \"\\n\\n=== PRIMARY TARGET MODULE ===\\n\",\n             f\"PATH: {f['path']}\\n\",\n             \"UNIFIED DIFF:\\n```diff\\n\" + (f.get(\"unified_diff\") or \"\") + \"\\n```\\n\",\n             \"FULL TEXT:\\n```python\\n\" + (f.get(\"full_text\") or \"\")[:20000] + \"\\n```\"]\n\n    parts.append(\"\\n=== CONTEXT MODULES (helpers/imports) ===\\n\")\n    for h in files:\n        if h[\"path\"] != f[\"path\"] and h.get(\"full_text\"):\n            parts.append(f\"\\n# {h['path']}\\n```python\\n{h['full_text'][:12000]}\\n```\")\n\n    tinfo = targets.get(f['path'], {})\n    parts.append(\"\\n=== TARGETS ===\\n\")\n    parts.append(json.dumps(tinfo, indent=2))\n\n    # automated code analysis guidance (structured)\n    try:\n        from llm_agent.code_analyzer import analyze_python_file, generate_test_guidance\n        guidance = generate_test_guidance(analyze_python_file(str(ROOT / f['path'])))\n        parts.append(\"\\n=== AUTOMATED CODE ANALYSIS GUIDANCE ===\\n\")\n        parts.append(guidance)\n    except Exception:\n        parts.append(\"\\n\u26a0\ufe0f Could not include automated code analysis guidance\")\n\n    if ctx.get(\"readme\"):\n        parts.append(\"\\nREADME (excerpt):\\n\" + ctx[\"readme\"][:1200])\n    if ctx.get(\"requirements\"):\n        parts.append(\"\\nrequirements.txt:\\n\" + ctx[\"requirements\"][:800])\n\n    parts.append(\"\\n\\nGenerate the pytest file now as per OUTPUT FORMAT.\")\n    return \"\\n\".join(parts)\n\n\ndef extract_filename_and_code(block_text):\n    lines = block_text.strip().splitlines()\n    if not lines:\n        name = f\"tests/generated/test_generated_{int(time.time())}.py\"\n        return name, block_text\n    hdr = lines[0]\n    if \"filename:\" not in hdr.lower():\n        name = f\"tests/generated/test_generated_{int(time.time())}.py\"\n        return name, \"\\n\".join(lines)\n    m = re.search(r\"filename:\\s*(.+\\.py)\", hdr, flags=re.I)\n    name = m.group(1).strip() if m else f\"tests/generated/test_generated_{int(time.time())}.py\"\n    code = \"\\n\".join(lines[1:])\n    return name, code\n\n\ndef validate_python(code: str) -> tuple[bool, str]:\n    \"\"\"Validate Python code and return (is_valid, error_message)\"\"\"\n    try:\n        ast.parse(code)\n        # Additional checks\n        if not code.strip():\n            return False, \"Empty code block\"\n        if \"import pytest\" not in code:\n            return False, \"Missing pytest import\"\n        if not any(line.strip().startswith(\"def test_\") for line in code.split('\\n')):\n            return False, \"No test functions found (must start with 'def test_')\"\n        return True, \"\"\n    except SyntaxError as e:\n        return False, f\"Syntax error: {e}\"\n    except Exception as e:\n        return False, f\"Parse error: {e}\"\n\n\ndef enforce_safe_imports(code: str) -> bool:\n    bad = [\"subprocess\", \"os.system\", \"requests.\", \"httpx.\", \"selenium\", \"playwright\"]\n    return not any(b in code for b in bad)\n\n\ndef call_ollama_once(prompt: str) -> str:\n    url = f\"{OLLAMA_HOST}/api/generate\"\n    payload = {\"model\": MODEL, \"prompt\": prompt, \"stream\": False}\n    r = requests.post(url, json=payload, timeout=600)\n    r.raise_for_status()\n    return r.json().get(\"response\", \"\")\n\n\ndef generate_for_module(bundle, module_path):\n    prompt = build_prompt_for_module(bundle, module_path)\n    if not prompt:\n        return None\n\n    attempts = 0\n    last_text = \"\"\n    last_error = \"\"\n    \n    while attempts < 3:\n        # Build retry prompt with specific error feedback\n        if attempts == 0:\n            current_prompt = prompt\n        else:\n            retry_guidance = f\"\\n\\nPREVIOUS ATTEMPT FAILED: {last_error}\\n\"\n            retry_guidance += \"REQUIREMENTS FOR RETRY:\\n\"\n            retry_guidance += \"- Must include 'import pytest' at the top\\n\"\n            retry_guidance += \"- All functions must start with 'def test_'\\n\" \n            retry_guidance += \"- Fix any syntax errors\\n\"\n            retry_guidance += \"- Use proper imports (no network/subprocess calls)\\n\"\n            retry_guidance += \"- Include pytest.raises for error cases\\n\"\n            retry_guidance += \"Please generate the corrected test file:\"\n            current_prompt = prompt + retry_guidance\n\n        print(f\"\ud83d\udd04 Attempt {attempts + 1}/3 for {module_path}\")\n        resp = call_ollama_once(current_prompt)\n        \n        # Extract code block\n        m = re.search(r\"```python(.*?)```\", resp, flags=re.S | re.I)\n        block = m.group(1).strip() if m else resp.strip()\n        filename, code = extract_filename_and_code(block)\n\n        # Validate safety and syntax\n        if not enforce_safe_imports(code):\n            last_error = \"Code contains unsafe imports (subprocess, requests, etc.)\"\n            attempts += 1\n            last_text = resp\n            continue\n            \n        is_valid, error_msg = validate_python(code)\n        if is_valid:\n            out_path = ROOT / filename\n            out_path.parent.mkdir(parents=True, exist_ok=True)\n            out_path.write_text(code, encoding=\"utf-8\")\n            print(f\"\u2705 Generated {out_path}\")\n            \n            # Quick syntax check by importing\n            try:\n                import tempfile\n                import sys\n                with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as tmp:\n                    tmp.write(code)\n                    tmp.flush()\n                    \n                # Test import (don't actually import to avoid side effects)\n                print(f\"\u2705 Syntax validated for {filename}\")\n                return out_path\n            except Exception as e:\n                print(f\"\u26a0\ufe0f Import test failed: {e}\")\n                last_error = f\"Import validation failed: {e}\"\n        else:\n            last_error = error_msg\n            \n        attempts += 1\n        last_text = resp\n        print(f\"\u274c Attempt {attempts}/3 failed: {last_error}\")\n\n    # All attempts failed - save for debugging\n    fallback = ROOT / f\"tests/generated/__invalid_{Path(module_path).stem}_{int(time.time())}.txt\"\n    fallback.write_text(f\"FAILED AFTER 3 ATTEMPTS\\nLast error: {last_error}\\n\\nLast response:\\n{last_text}\", encoding=\"utf-8\")\n    print(f\"\u274c Failed to generate valid tests for {module_path}. Debug info saved to {fallback}\")\n    return None\n\n\nif __name__ == \"__main__\":\n    bundle = load_bundle()\n    changed_modules = [f[\"path\"] for f in bundle[\"files\"] if f[\"path\"].endswith(\".py\")]\n    changed_modules = [p for p in changed_modules if any(f[\"path\"] == p and f.get(\"unified_diff\") for f in bundle[\"files\"])]\n    if not changed_modules:\n        print(\"\u2139\ufe0f No changed Python modules detected with diffs.\")\n    for mod in changed_modules:\n        generate_for_module(bundle, mod)",
      "unified_diff": "diff --git a/llm_agent/generate_tests.py b/llm_agent/generate_tests.py\nindex 8e2f134..3eeffe6 100644\n--- a/llm_agent/generate_tests.py\n+++ b/llm_agent/generate_tests.py\n@@ -11,7 +11,7 @@ BUNDLE = ROOT / \"ci_artifacts\" / \"context_bundle.json\"\n OUT_DIR = ROOT / \"tests\" / \"generated\"\n OUT_DIR.mkdir(parents=True, exist_ok=True)\n \n-MODEL = os.getenv(\"OLLAMA_MODEL\", \"qwen2.5-coder:7b\")\n+MODEL = os.getenv(\"OLLAMA_MODEL\", \"qwen2.5-coder:1.5b\")  # Smaller model for CI\n OLLAMA_HOST = os.getenv(\"OLLAMA_HOST\", \"http://localhost:11434\")\n PROMPT_TEMPLATE = (ROOT / \"llm_agent\" / \"prompt_template.txt\").read_text(encoding=\"utf-8\")\n \n@@ -79,12 +79,22 @@ def extract_filename_and_code(block_text):\n     return name, code\n \n \n-def validate_python(code: str) -> bool:\n+def validate_python(code: str) -> tuple[bool, str]:\n+    \"\"\"Validate Python code and return (is_valid, error_message)\"\"\"\n     try:\n         ast.parse(code)\n-        return True\n-    except Exception:\n-        return False\n+        # Additional checks\n+        if not code.strip():\n+            return False, \"Empty code block\"\n+        if \"import pytest\" not in code:\n+            return False, \"Missing pytest import\"\n+        if not any(line.strip().startswith(\"def test_\") for line in code.split('\\n')):\n+            return False, \"No test functions found (must start with 'def test_')\"\n+        return True, \"\"\n+    except SyntaxError as e:\n+        return False, f\"Syntax error: {e}\"\n+    except Exception as e:\n+        return False, f\"Parse error: {e}\"\n \n \n def enforce_safe_imports(code: str) -> bool:\n@@ -107,26 +117,70 @@ def generate_for_module(bundle, module_path):\n \n     attempts = 0\n     last_text = \"\"\n+    last_error = \"\"\n+    \n     while attempts < 3:\n-        resp = call_ollama_once(prompt if attempts == 0 else (\n-            prompt + \"\\n\\nThe previous output failed to parse. Fix syntax/imports and resend the corrected file.\"))\n+        # Build retry prompt with specific error feedback\n+        if attempts == 0:\n+            current_prompt = prompt\n+        else:\n+            retry_guidance = f\"\\n\\nPREVIOUS ATTEMPT FAILED: {last_error}\\n\"\n+            retry_guidance += \"REQUIREMENTS FOR RETRY:\\n\"\n+            retry_guidance += \"- Must include 'import pytest' at the top\\n\"\n+            retry_guidance += \"- All functions must start with 'def test_'\\n\" \n+            retry_guidance += \"- Fix any syntax errors\\n\"\n+            retry_guidance += \"- Use proper imports (no network/subprocess calls)\\n\"\n+            retry_guidance += \"- Include pytest.raises for error cases\\n\"\n+            retry_guidance += \"Please generate the corrected test file:\"\n+            current_prompt = prompt + retry_guidance\n+\n+        print(f\"\ud83d\udd04 Attempt {attempts + 1}/3 for {module_path}\")\n+        resp = call_ollama_once(current_prompt)\n+        \n+        # Extract code block\n         m = re.search(r\"```python(.*?)```\", resp, flags=re.S | re.I)\n         block = m.group(1).strip() if m else resp.strip()\n         filename, code = extract_filename_and_code(block)\n \n-        if enforce_safe_imports(code) and validate_python(code):\n+        # Validate safety and syntax\n+        if not enforce_safe_imports(code):\n+            last_error = \"Code contains unsafe imports (subprocess, requests, etc.)\"\n+            attempts += 1\n+            last_text = resp\n+            continue\n+            \n+        is_valid, error_msg = validate_python(code)\n+        if is_valid:\n             out_path = ROOT / filename\n             out_path.parent.mkdir(parents=True, exist_ok=True)\n             out_path.write_text(code, encoding=\"utf-8\")\n-            print(f\"\u2705 wrote {out_path}\")\n-            return out_path\n-\n+            print(f\"\u2705 Generated {out_path}\")\n+            \n+            # Quick syntax check by importing\n+            try:\n+                import tempfile\n+                import sys\n+                with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as tmp:\n+                    tmp.write(code)\n+                    tmp.flush()\n+                    \n+                # Test import (don't actually import to avoid side effects)\n+                print(f\"\u2705 Syntax validated for {filename}\")\n+                return out_path\n+            except Exception as e:\n+                print(f\"\u26a0\ufe0f Import test failed: {e}\")\n+                last_error = f\"Import validation failed: {e}\"\n+        else:\n+            last_error = error_msg\n+            \n         attempts += 1\n         last_text = resp\n+        print(f\"\u274c Attempt {attempts}/3 failed: {last_error}\")\n \n-    fallback = ROOT / f\"tests/generated/__invalid_{Path(module_path).stem}.txt\"\n-    fallback.write_text(last_text, encoding=\"utf-8\")\n-    print(f\"\u26a0\ufe0f saved invalid output to {fallback}\")\n+    # All attempts failed - save for debugging\n+    fallback = ROOT / f\"tests/generated/__invalid_{Path(module_path).stem}_{int(time.time())}.txt\"\n+    fallback.write_text(f\"FAILED AFTER 3 ATTEMPTS\\nLast error: {last_error}\\n\\nLast response:\\n{last_text}\", encoding=\"utf-8\")\n+    print(f\"\u274c Failed to generate valid tests for {module_path}. Debug info saved to {fallback}\")\n     return None\n \n \n"
    }
  ],
  "context": {
    "readme": "# Bank Transaction Analyzer\n**A finance transaction analyzer built with Streamlit, Pandas, and Seaborn for visualizing banking data.**\n\n\nA simple yet insightful dashboard designed to help you analyze and visualize your bank transaction data with ease.\n\n---\n\n## Features\n\n- **Interactive Data Display**: Easily view and sort transaction details.\n- **Dynamic Visualizations**:\n  - **Transactions Over Time**\n  - **Spending by Category**\n- **Realistic Transaction Data**: Mock data with meaningful descriptions tailored to Switzerland.\n\n---\n\n## Screenshots\n\n\n<img width=\"376\" alt=\"image\" src=\"https://github.com/user-attachments/assets/aab2ae5f-ed67-44f3-89fe-66b5d4a430b0\" />\n\n\n\n<img width=\"563\" alt=\"image\" src=\"https://github.com/user-attachments/assets/c0011c2a-24b1-41da-a4c7-f189efdae563\" />\n\n\n---\n\n## \u25b6Live Demo\n\nCheck out the live application hosted on Streamlit Cloud:\n\n[View Live App](https://bank-transaction-analyzer-ehpwd798thscecawnjyqcc.streamlit.app/)\n\n---\n\n## \ud83d\udee0\ufe0f Technologies Used\n\n- [Streamlit](https://streamlit.io/)\n- [Pandas](https://pandas.pydata.org/)\n- [Matplotlib](https://matplotlib.org/)\n- [Seaborn](https://seaborn.pydata.org/)\n- [Faker](https://faker.readthedocs.io/)\n- [Python](https://www.python.org/)\n\n---\n\n## Getting Started (Local Installation)\n\nTo run this project locally:\n\n1. Clone this repository:\n\n\ngit clone https://github.com/oksanalim/bank-transaction-analyzer.git\n```\ncd bank-transaction-analyzer\n```\n2. Install dependencies:\n```\npip install -r requirements.txt\n```\n3. Run the Streamlit app:\n```\nstreamlit run dashboard.py\n```\nData Source\nThe current data is mock data generated using Faker for demonstration purposes.\n\nTo generate your own transaction data, simply run:\n```\npython generate_mock_data.py\n```\n\n\ud83e\udd1d Contributing\nFeel free to fork this repository, submit issues, and send pull requests. Contributions are welcome!\n",
    "requirements": "streamlit\npsycopg2-binary\npandas\nmatplotlib\nseaborn\nsqlalchemy\nnumpy\npillow\nrequests\npytest\npytest-cov\ncoverage\n\n",
    "sample_data": {
      "data/transactions.csv": "transaction_date,amount,category_id,category_name,description\n2024-07-23,252.22,5,Shopping,Furniture shopping at IKEA\n2024-06-29,135.16,6,Dining,Coffee at Starbucks\n2024-12-03,140.45,4,Utilities,Electricity bill payment\n2024-07-19,86.44,9,Other,Unexpected expense\n2024-06-06,374.4,7,Health & Fitness,Fitness abo at Holmes Place\n2024-12-25,323.66,9,Other,Gift purchase at Manor\n2024-12-30,183.75,4,Utilities,Utilities bill\n2024-06-17,122.76,6,Dining,Lunch at Tibits\n2024-12-29,30.44,1,Groceries,Shopping at Coop\n2024-12-09,107.61,9,Other,Unexpected expense\n2024-05-29,256.97,5,Shopping,Clothing at H&M\n2025-01-20,938.66,9,Other,Bank service fee\n2024-11-12,17.69,3,Transportation,Halb-Tax (Swiss railway discount)\n2024-09-05,214.06,2,Entertainment,Netflix monthly subscription\n2024-05-19,249.39,9,Other,Car parking fee\n2024-10-19,171.54,4,Utilities,Mobile bill at Salt\n2025-01-25,85.5,3,Transportation,Fill up car at Esso\n2024-09-28,122.08,1,Groceries,Organic food at Alnatura\n2024-12-09,505.74,9,Other,Unexpected expense\n2025-02-26,177.64,8,Education,German language class\n2024-04-03,19.43,3,Transportation,Fill up car at Esso\n2024-10-09,297.37,7,Health & Fitness,Doctor consultation at MedBase\n2024-03-13,118.3,4,Utilities,Swisscom internet subscription\n2025-03-05,468.16,7,Health & Fitness,Yoga class subscription\n2024-06-20,81.99,7,Health & Fitness,Fitness abo at Holmes Place\n2024-04-19,154.34,5,Shopping,Clothing at H&M\n2025-01-10,22.12,7,Health & Fitness,Doctor consultation at MedBase\n2024-06-08,149.36,3,Transportation,Tram pass renewal\n2024-07-22,143.46,6,Dining,Weekend brunch at Spr\u00fcngli\n2024-03-15,140.57,6,Dining,Dinner at Vapiano\n2024-08-15,895.59,9,Other,Bank service fee\n2025-02-19,51.55,1,Groceries,Shopping at Migros\n2025-01-22,143.19,1,Groceries,Shopping at Migros\n2025-01-18,267.17,5,Shopping,Shoe shopping at Ochsner Sport\n2024-06-13,578.05,9,Other,Unexpected expense\n2024-05-18,497.48,9,Other,Charity donation\n2025-01-09,159.63,9,Other,Gift purchase at Manor\n2024-09-28,27.43,1,Groceries,Weekly grocery shopping\n2025-01-31,119.14,6,Dining,Weekend brunch at Spr\u00fcngli\n2024-08-06,83.81,6,Dining,Lunch at Tibits\n2024-11-18,55.82,8,Education,German language class\n2025-01-02,94.25,6,Dining,Weekend brunch at Spr\u00fcngli\n2024-11-28,17.0,3,Transportation,Train ticket Z\u00fcrich to Bern\n2024-09-27,127.37,1,Groceries,Weekly grocery shopping\n2024-03-29,51.55,3,Transportation,Halb-Tax (Swiss railway discount)\n2025-03-01,69.74,6,Dining,Lunch at Tibits\n2024-04-20,563.12,9,Other,Charity donation\n2024-04-18,258.24,5,Shopping,Electronics at Interdiscount\n2024-06-07,164.88,2,Entertainment,Z\u00fcrich Opera House ticket\n2024-10-19,59.13,5,Shopping,Shoe shopping at Ochsner Sport\n"
    }
  },
  "metadata": {
    "generated_at": "2025-11-02T21:34:03.259938",
    "total_files": 1,
    "changed_files": 1,
    "dependency_files": 0
  }
}